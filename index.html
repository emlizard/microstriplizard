<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Microstrip Line Calculator (W ↔ Z₀)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      line-height: 1.6;
    }
    h1, h2, h3 {
      color: #333;
    }
    label {
      display: inline-block;
      width: 240px;
      margin-bottom: 5px;
    }
    input[type="number"] {
      margin-bottom: 10px;
      padding: 5px;
      width: 120px;
    }
    .common-flex {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }
    .common-container {
      flex: 1;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    .diagram-container {
      flex: 1;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f9f9f9;
      text-align: center;
      width: 300px;
      height: auto;
    }
    .calc-container {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }
    .section {
      flex: 1;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    .result-container {
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f9f9f9;
      margin-bottom: 30px;
      text-align: center;
    }
    .formula, .references {
      margin-bottom: 30px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    button {
      padding: 8px 15px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
    }
    img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
    }
  </style>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async 
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
</head>
<body>
  <h1>Microstrip Line Calculator (W ↔ Z₀)</h1>

  <div class="common-flex">
    <div class="common-container">
      <h2>Common Inputs</h2>
      <div>
        <label for="ms-h">Substrate Height (h) [mm]:</label>
        <input type="number" id="ms-h" step="any" value="1.6"><br>
        <label for="ms-eps">Dielectric Constant (εᵣ):</label>
        <input type="number" id="ms-eps" step="any" value="4.4"><br>
        <label for="ms-t">Conductor Thickness (t) [µm]:</label>
        <input type="number" id="ms-t" step="any" value="35"><br>
      </div>
    </div>
    <div class="diagram-container">
      <h2>Cross-Section Diagram</h2>
      <img src="https://emlizard.github.io/main-page/images/diagram_MSL.png" alt="Microstrip cross-section" class="content-img">
    </div>
  </div>

  <div class="calc-container">
    <div class="section">
      <h2>W to Z₀ Calculation</h2>
      <div>
        <label for="ms-W-input">Signal Line Width W [mm]:</label>
        <input type="number" id="ms-W-input" step="any" value="3"><br>
        <button type="button" onclick="calculateZ0_fromW()">Calculate</button>
      </div>
    </div>
    <div class="section">
      <h2>Z₀ to W Calculation</h2>
      <div>
        <label for="ms-Z0-input">Target Z₀ [Ohm]:</label>
        <input type="number" id="ms-Z0-input" step="any" value="50"><br>
        <button type="button" onclick="calculateW_fromZ0()">Calculate</button>
      </div>
    </div>
  </div>

  <div class="result-container">
    <h2>Result</h2>
    <div id="resultArea" style="margin-top: 15px; font-weight: bold;"></div>
  </div>

  <div class="formula">
    <h2>Formulas</h2>
    <p>
      <strong>Effective Conductor Width \(W_{\mathrm{eff}}\):</strong><br>
      \[
      W_{\mathrm{eff}} =
      \begin{cases}
      W, & t \le 0,\\[1mm]
      W + \dfrac{t}{\pi}\ln\!\Bigl(1+\dfrac{4e\,h}{t}\Bigr), & t>0,
      \end{cases}
      \]
    </p>
    <p>
      <strong>Effective Dielectric Constant \(\epsilon_{\mathrm{eff}}\):</strong><br>
      \[
      \epsilon_{\mathrm{eff}} = \frac{\epsilon_r+1}{2} + \frac{\epsilon_r-1}{2}\frac{1}{\sqrt{1+12\frac{h}{W_{\mathrm{eff}}}}}
      \]
    </p>
    <p>
      <strong>Characteristic Impedance \(Z_0\):</strong><br>
      For \( \frac{W_{\mathrm{eff}}}{h} \le 1 \):<br>
      \[
      Z_0 = \frac{60}{\sqrt{\epsilon_{\mathrm{eff}}}} \ln\!\Bigl(\frac{8h}{W_{\mathrm{eff}}} + \frac{W_{\mathrm{eff}}}{4h}\Bigr)
      \]
      <br>
      For \( \frac{W_{\mathrm{eff}}}{h} > 1 \):<br>
      \[
      Z_0 = \frac{120\pi}{\sqrt{\epsilon_{\mathrm{eff}}}\Bigl(\frac{W_{\mathrm{eff}}}{h}+1.393+0.667\ln\!\Bigl(\frac{W_{\mathrm{eff}}}{h}+1.444\Bigr)\Bigr)}
      \]
    </p>
  </div>

  <div class="references">
    <h2>References</h2>
    <p>
      <strong>Hammerstad &amp; Jensen (1980):</strong><br>
      Accurate Models for Microstrip Computer-Aided Design. IEEE Transactions on Microwave Theory and Techniques, 28(2), 344–351.
    </p>
    <p>
      <strong>Pozar, D. M. Microwave Engineering.</strong>
    </p>
  </div>

  <script>
    const pi = Math.PI;
    const e_const = Math.E;

    function getCommonParams() {
      let h_mm = parseFloat(document.getElementById("ms-h").value);
      let eps_r = parseFloat(document.getElementById("ms-eps").value);
      let t_um = parseFloat(document.getElementById("ms-t").value);
      return {
        h: h_mm / 1000,
        eps_r: eps_r,
        t: t_um * 1e-6
      };
    }

    function calcMicrostrip(W_mm, common) {
      let h = common.h;
      let eps_r = common.eps_r;
      let t = common.t;
      let W = W_mm / 1000;

      let W_eff = (t <= 0) ? W : W + (t / pi) * Math.log(1 + (4 * e_const * h) / t);
      let eps_eff = (eps_r + 1) / 2 + ((eps_r - 1) / 2) / Math.sqrt(1 + 12 * h / W_eff);

      let ratio = W_eff / h;
      let Z0;
      if (ratio <= 1) {
        Z0 = (60 / Math.sqrt(eps_eff)) * Math.log((8 * h) / W_eff + (W_eff / (4 * h)));
      } else {
        Z0 = (120 * pi) / (Math.sqrt(eps_eff) * (ratio + 1.393 + 0.667 * Math.log(ratio + 1.444)));
      }

      return { Z0: Z0, eps_eff: eps_eff, W_eff: W_eff };
    }

    function calculateZ0_fromW() {
      let common = getCommonParams();
      let W_mm = parseFloat(document.getElementById("ms-W-input").value);
      let result = calcMicrostrip(W_mm, common);
      document.getElementById("resultArea").innerHTML =
        "Calculated Characteristic Impedance Z₀ = " + result.Z0.toFixed(2) + " Ohm<br>" +
        "Effective Dielectric Constant ε_eff = " + result.eps_eff.toFixed(3);
    }

    function findW_for_Z0(targetZ0, common) {
      let W_guess = 3;
      let tol = 1e-6;
      let maxIter = 100;
      for (let i = 0; i < maxIter; i++) {
        let result = calcMicrostrip(W_guess, common);
        let f_val = result.Z0 - targetZ0;
        if (Math.abs(f_val) < tol) return W_guess;
        let dW = 1e-6;
        let Z0_plus = calcMicrostrip(W_guess + dW, common).Z0;
        let Z0_minus = calcMicrostrip(W_guess - dW, common).Z0;
        let derivative = (Z0_plus - Z0_minus) / (2 * dW);
        if (Math.abs(derivative) < 1e-12) break;
        let W_next = W_guess - f_val / derivative;
        if (Math.abs(W_next - W_guess) < tol) return W_next;
        W_guess = W_next;
      }
      return W_guess;
    }

    function calculateW_fromZ0() {
      let common = getCommonParams();
      let targetZ0 = parseFloat(document.getElementById("ms-Z0-input").value);
      let W_calc = findW_for_Z0(targetZ0, common);
      let result = calcMicrostrip(W_calc, common);
      document.getElementById("resultArea").innerHTML =
        "Target Z₀ = " + targetZ0 + " Ohm corresponds to W = " + W_calc.toFixed(4) + " mm<br>" +
        "Effective Dielectric Constant ε_eff = " + result.eps_eff.toFixed(3);
    }
  </script>
</body>
</html>
